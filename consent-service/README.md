# Consent Service

Subject-agnostic consent management service for handling privacy policies, marketing consents, and other policy types.

## Features

- **Policy Management**: Create and version consent policies (privacy, marketing, cookies, etc.)
- **Consent Tracking**: Record subject consents with audit trail
- **Shareable Links**: Generate time-limited links for consent collection
- **Subject-Agnostic**: Uses generic `subject` identifier - no dependency on other services

## Technology Stack

- **Go 1.21**
- **Gin** - HTTP router
- **MongoDB** - Data storage
- **Zerolog** - Structured logging
- **Koanf** - Configuration management

## Getting Started

### Prerequisites

- Go 1.21+
- MongoDB 6.0+
- Docker (optional)

### Running Locally

1. Start MongoDB:
```bash
docker-compose up -d mongo
```

2. Install dependencies and tools:
```bash
make deps
make install-tools
```

3. Generate API code from OpenAPI spec:
```bash
make generate
```

4. Run the service:
```bash
make run
```

The service will start on `http://localhost:8085`.

### Development Workflow

When modifying the API:
1. Update `api/openapi.yaml`
2. Run `make generate` to regenerate the Go types and server interfaces
3. Update `internal/port/http/api/server.go` to implement any new endpoints

### Running with Docker

```bash
make docker-build
make docker-run
```

## Configuration

Configuration is loaded from environment variables with the `CONSENT_` prefix:

| Variable | Description | Default |
|----------|-------------|---------|
| `CONSENT_SERVER_PORT` | HTTP server port | 8085 |
| `CONSENT_SERVER_BASE_URL` | Base URL for generated links | http://localhost:8085 |
| `CONSENT_MONGODB_CONNECTION_STRING` | MongoDB connection string | mongodb://localhost:27017 |
| `CONSENT_MONGODB_DATABASE` | Database name | consents |

## API Endpoints

### Admin API (Authenticated)

| Method | Path | Description |
|--------|------|-------------|
| `GET` | `/admin/policies` | List all policies |
| `GET` | `/admin/policies/{slug}` | Get policy details |
| `POST` | `/admin/policies` | Create new policy |
| `POST` | `/admin/policies/{slug}/versions` | Add policy version |
| `GET` | `/admin/consents?subject={id}` | Get subject's consents |
| `POST` | `/admin/consents` | Create consent (direct) |
| `DELETE` | `/admin/consents/{id}` | Revoke consent |
| `POST` | `/admin/links` | Create consent link |
| `GET` | `/admin/links/{token}` | Get link status |
| `DELETE` | `/admin/links/{token}` | Invalidate link |

### Public API (No Auth)

| Method | Path | Description |
|--------|------|-------------|
| `GET` | `/public/links/{token}` | Get link info |
| `POST` | `/public/links/{token}/accept` | Accept consents |

### Health Endpoints

| Method | Path | Description |
|--------|------|-------------|
| `GET` | `/health` | Health check |
| `GET` | `/ready` | Readiness check |

## Usage Examples

### Create a Policy

```bash
curl -X POST http://localhost:8085/admin/policies \
  -H "Content-Type: application/json" \
  -d '{
    "slug": "privacy-policy",
    "name": "Privacy Policy",
    "description": "Our privacy policy"
  }'
```

### Add a Version

```bash
curl -X POST http://localhost:8085/admin/policies/privacy-policy/versions \
  -H "Content-Type: application/json" \
  -d '{
    "version": "1.0.0",
    "content_html": "<h1>Privacy Policy</h1>...",
    "is_active": true
  }'
```

### Create Consent (Direct/Tablet)

```bash
curl -X POST http://localhost:8085/admin/consents \
  -H "Content-Type: application/json" \
  -d '{
    "subject": "customer-uuid-123",
    "policies": [
      { "slug": "privacy-policy" }
    ]
  }'
```

### Generate Consent Link

```bash
curl -X POST http://localhost:8085/admin/links \
  -H "Content-Type: application/json" \
  -d '{
    "subject": "customer-uuid-123",
    "policies": ["privacy-policy", "marketing-consent"],
    "expires_in_hours": 48,
    "created_by": "operator-123"
  }'
```

## Testing

```bash
# Run all tests
make test

# Run with coverage
make test-coverage
```

## Project Structure

```
consent-service/
├── cmd/server/              # Application entry point
├── internal/
│   ├── domain/              # Core business logic
│   ├── application/         # Use cases and services
│   ├── port/http/
│   │   ├── api/             # Generated types + server implementation
│   │   │   ├── generate.go  # go:generate directive
│   │   │   ├── generated.go # Generated by oapi-codegen (do not edit)
│   │   │   └── server.go    # StrictServerInterface implementation
│   │   └── router.go        # Gin router setup
│   ├── infra/mongo/         # MongoDB repositories
│   └── config/              # Configuration
├── api/
│   ├── openapi.yaml         # OpenAPI 3.0 specification (source of truth)
│   └── oapi-codegen.yaml    # oapi-codegen configuration
└── api-tests/               # HTTP test files
```

## License

Proprietary - BeAesthetic
